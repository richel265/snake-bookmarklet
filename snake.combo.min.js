javascript:(function(){"use strict";var grid,snake,currentDirection,moveQueue,hasMoved,whitespaceReplacementChar,GRID_WIDTH=31,SNAKE_CELL=1,FOOD_CELL=2,UP={x:0,y:-1},DOWN={x:0,y:1},LEFT={x:-1,y:0},RIGHT={x:1,y:0},INITIAL_SNAKE_LENGTH=4,BRAILLE_SPACE="⠀",gamePaused=!1,urlRevealed=!1;function main(){detectBrowserUrlWhitespaceEscaping(),cleanUrl(),setupEventHandlers(),drawMaxScore(),initUrlRevealed(),startGame();var e=Date.now();window.requestAnimationFrame((function t(){var r=Date.now();!gamePaused&&r-e>=tickTime()&&(updateWorld(),drawWorld(),e=r),window.requestAnimationFrame(t)}))}function pickWhitespaceReplacementChar(){var e=[["૟","strange symbols"],["⟋","some weird slashes"]],t=document.createElement("canvas"),r=t.getContext("2d");r.font="30px system-ui";for(var a=r.measureText(BRAILLE_SPACE.repeat(5)).width,n=0;n<e.length;n++){var o=e[n][0].repeat(5),i=r.measureText(o).width,l=Math.abs(a-i)/a<=.1;r.clearRect(0,0,t.width,t.height),r.fillText(o,0,30);for(var c=r.getImageData(0,0,i,30).data,u=c.length/4,s=0,d=0;d<u;d++){0!=c[4*d+3]&&s++}if(l&&s/u<.15)return e[n]}return["░",'some kind of "fog"']}function detectBrowserUrlWhitespaceEscaping(){if(history.replaceState(null,null,"#"+BRAILLE_SPACE+BRAILLE_SPACE),-1==location.hash.indexOf(BRAILLE_SPACE)){console.warn("Browser is escaping whitespace characters on URL");var e=pickWhitespaceReplacementChar();whitespaceReplacementChar=e[0]}}function cleanUrl(){history.replaceState(null,null,location.pathname.replace(/\b\/$/,""))}function setupEventHandlers(){var e={37:LEFT,38:UP,39:RIGHT,40:DOWN,87:UP,65:LEFT,83:DOWN,68:RIGHT,75:UP,72:LEFT,74:DOWN,76:RIGHT};document.onkeydown=function(t){var r=t.keyCode;r in e&&changeDirection(e[r])},window.onblur=function(){gamePaused=!0,window.history.replaceState(null,null,location.hash+"[paused]")},window.onfocus=function(){gamePaused=!1,drawWorld()}}function drawMaxScore(){var e=localStorage.maxScore;if(null!=e)localStorage.maxScoreGrid;else e=0}function initUrlRevealed(){setUrlRevealed(Boolean(localStorage.urlRevealed))}function setUrlRevealed(e){(urlRevealed=e)?localStorage.urlRevealed="y":delete localStorage.urlRevealed}function startGame(){grid=new Array(4*GRID_WIDTH),snake=[];for(var e=0;e<INITIAL_SNAKE_LENGTH;e++){snake.unshift({x:e,y:2}),setCellAt(e,2,SNAKE_CELL)}currentDirection=RIGHT,moveQueue=[],hasMoved=!1,dropFood()}function updateWorld(){moveQueue.length&&(currentDirection=moveQueue.pop());var e=snake[0],t=snake[snake.length-1],r=e.x+currentDirection.x,a=e.y+currentDirection.y,n=r<0||r>=GRID_WIDTH||a<0||a>=4,o=cellAt(r,a)===SNAKE_CELL&&!(r===t.x&&a===t.y);if(n||o)return endGame(),void startGame();var i=cellAt(r,a)===FOOD_CELL;i||(snake.pop(),setCellAt(t.x,t.y,null)),setCellAt(r,a,SNAKE_CELL),snake.unshift({x:r,y:a}),i&&dropFood()}function endGame(){var e=currentScore();console.log("Final score:",e);var t=parseInt(localStorage.maxScore||0);e>0&&e>t&&hasMoved&&(localStorage.maxScore=e,localStorage.maxScoreGrid=gridString(),drawMaxScore())}function drawWorld(){var e="#|"+gridString()+"|[score:"+currentScore()+"]|[highscore:"+localStorage.maxScore+"][highscoreGrid:"+localStorage.maxScoreGrid+"]",t="|"+gridString()+"|["+currentScore()+"h"+localStorage.maxScore+"]";urlRevealed&&($("#url").textContent=location.href.replace(/#.*$/,"")+e),whitespaceReplacementChar&&(e=e.replace(/\u2800/g,whitespaceReplacementChar)),history.replaceState(null,null,e),document.title=t,decodeURIComponent(location.hash)!==e&&(console.warn("history.replaceState() throttling detected. Using location.hash fallback"),location.hash=e,document.title=t)}function gridString(){for(var e="",t=0;t<GRID_WIDTH;t+=2){var r=0|bitAt(t,0)<<0|bitAt(t,1)<<1|bitAt(t,2)<<2|bitAt(t+1,0)<<3|bitAt(t+1,1)<<4|bitAt(t+1,2)<<5|bitAt(t,3)<<6|bitAt(t+1,3)<<7;e+=String.fromCharCode(10240+r)}return e}function tickTime(){return 125+-50*snake.length/grid.length}function currentScore(){return snake.length-INITIAL_SNAKE_LENGTH}function cellAt(e,t){return grid[e%GRID_WIDTH+t*GRID_WIDTH]}function bitAt(e,t){return cellAt(e,t)?1:0}function setCellAt(e,t,r){grid[e%GRID_WIDTH+t*GRID_WIDTH]=r}function dropFood(){var e=grid.length-snake.length;if(0!==e)for(var t=Math.floor(Math.random()*e),r=0;r<grid.length;r++)if(grid[r]!==SNAKE_CELL){if(0===t){grid[r]=FOOD_CELL;break}t--}}function changeDirection(e){var t=moveQueue[0]||currentDirection;e.x+t.x===0&&e.y+t.y===0||moveQueue.unshift(e),hasMoved=!0}var $=document.querySelector.bind(document);main();}());
