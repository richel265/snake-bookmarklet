javascript:(function(){"use strict";var grid,snake,currentDirection,moveQueue,hasMoved,whitespaceReplacementChar,GRID_WIDTH=33,SNAKE_CELL=1,FOOD_CELL=2,UP={x:0,y:-1},DOWN={x:0,y:1},LEFT={x:-1,y:0},RIGHT={x:1,y:0},INITIAL_SNAKE_LENGTH=4,BRAILLE_SPACE="⠀",gamePaused=!1,urlRevealed=!1;function main(){detectBrowserUrlWhitespaceEscaping(),cleanUrl(),setupEventHandlers(),initUrlRevealed(),startGame();var e=Date.now();window.requestAnimationFrame((function t(){var n=Date.now();!gamePaused&&n-e>=tickTime()&&(updateWorld(),drawWorld(),e=n),window.requestAnimationFrame(t)}))}function pickWhitespaceReplacementChar(){var e=[["૟","strange symbols"],["⟋","some weird slashes"]],t=document.createElement("canvas"),n=t.getContext("2d");n.font="30px system-ui";for(var r=n.measureText(BRAILLE_SPACE.repeat(5)).width,a=0;a<e.length;a++){var o=e[a][0].repeat(5),i=n.measureText(o).width,l=Math.abs(r-i)/r<=.1;n.clearRect(0,0,t.width,t.height),n.fillText(o,0,30);for(var c=n.getImageData(0,0,i,30).data,u=c.length/4,s=0,d=0;d<u;d++){0!=c[4*d+3]&&s++}if(l&&s/u<.15)return e[a]}return["░",'some kind of "fog"']}function detectBrowserUrlWhitespaceEscaping(){if(history.replaceState(null,null,"#"+BRAILLE_SPACE+BRAILLE_SPACE),-1==location.hash.indexOf(BRAILLE_SPACE)){console.warn("Browser is escaping whitespace characters on URL");var e=pickWhitespaceReplacementChar();whitespaceReplacementChar=e[0]}}function cleanUrl(){history.replaceState(null,null,location.pathname.replace(/\b\/$/,""))}function setupEventHandlers(){var e={37:LEFT,38:UP,39:RIGHT,40:DOWN,87:UP,65:LEFT,83:DOWN,68:RIGHT,75:UP,72:LEFT,74:DOWN,76:RIGHT};document.onkeydown=function(t){var n=t.keyCode;n in e&&changeDirection(e[n])},window.onblur=function(){gamePaused=!0,window.history.replaceState(null,null,location.hash+"[paused]"),document.title=document.title+"[p]"},window.onfocus=function(){gamePaused=!1,drawWorld()}}function initUrlRevealed(){setUrlRevealed(Boolean(localStorage.urlRevealed))}function setUrlRevealed(e){(urlRevealed=e)?localStorage.urlRevealed="y":delete localStorage.urlRevealed}function startGame(){grid=new Array(4*GRID_WIDTH),snake=[];for(var e=0;e<INITIAL_SNAKE_LENGTH;e++){snake.unshift({x:e,y:2}),setCellAt(e,2,SNAKE_CELL)}currentDirection=RIGHT,moveQueue=[],hasMoved=!1,dropFood()}function updateWorld(){moveQueue.length&&(currentDirection=moveQueue.pop());var e=snake[0],t=snake[snake.length-1],n=e.x+currentDirection.x,r=e.y+currentDirection.y,a=n<0||n>=GRID_WIDTH||r<0||r>=4,o=cellAt(n,r)===SNAKE_CELL&&!(n===t.x&&r===t.y);if(a||o)return endGame(),void startGame();var i=cellAt(n,r)===FOOD_CELL;i||(snake.pop(),setCellAt(t.x,t.y,null)),setCellAt(n,r,SNAKE_CELL),snake.unshift({x:n,y:r}),i&&dropFood()}function endGame(){var e=currentScore();console.log("Final score:",e)}function drawWorld(){var e="#|"+gridString()+"|[score:"+currentScore()+"]",t="|"+gridString()+"|["+currentScore()+"]";urlRevealed&&($("#url").textContent=location.href.replace(/#.*$/,"")+e),whitespaceReplacementChar&&(e=e.replace(/\u2800/g,whitespaceReplacementChar)),history.replaceState(null,null,e),document.title=t,decodeURIComponent(location.hash)!==e&&(console.warn("history.replaceState() throttling detected. Using location.hash fallback"),location.hash=e,document.title=t)}function gridString(){for(var e="",t=0;t<GRID_WIDTH;t+=2){var n=0|bitAt(t,0)<<0|bitAt(t,1)<<1|bitAt(t,2)<<2|bitAt(t+1,0)<<3|bitAt(t+1,1)<<4|bitAt(t+1,2)<<5|bitAt(t,3)<<6|bitAt(t+1,3)<<7;e+=String.fromCharCode(10240+n)}return e}function tickTime(){return 125+-50*snake.length/grid.length}function currentScore(){return snake.length-INITIAL_SNAKE_LENGTH}function cellAt(e,t){return grid[e%GRID_WIDTH+t*GRID_WIDTH]}function bitAt(e,t){return cellAt(e,t)?1:0}function setCellAt(e,t,n){grid[e%GRID_WIDTH+t*GRID_WIDTH]=n}function dropFood(){var e=grid.length-snake.length;if(0!==e)for(var t=Math.floor(Math.random()*e),n=0;n<grid.length;n++)if(grid[n]!==SNAKE_CELL){if(0===t){grid[n]=FOOD_CELL;break}t--}}function changeDirection(e){var t=moveQueue[0]||currentDirection;e.x+t.x===0&&e.y+t.y===0||moveQueue.unshift(e),hasMoved=!0}var $=document.querySelector.bind(document);main();}());
